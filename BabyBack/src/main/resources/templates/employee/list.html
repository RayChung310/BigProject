<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">

<head>
<meta charset="UTF-8">
<title>員工權限管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
</head>

<body style="background-color: #f8f9fa;">
	<div class="container mt-5">
		<h2 class="mb-4 text-center">員工權限管理</h2>

		<table class="table table-bordered table-hover bg-white">
			<thead class="table-secondary text-center">
				<tr>
					<th>ID</th>
					<th>帳號</th>
					<th>姓名</th>
					<th>角色</th>
					<!-- <th>狀態</th> -->
					<th>操作</th>
				</tr>
			</thead>
			<tbody class="text-center" th:each="emp : ${employees}">
				<!-- Thymeleaf 的迴圈語法:${employees} 是從後端傳進來的員工清單（List<UserAccount>）emp 是迴圈中的每一筆員工資料。這段意思是：「對每一筆 employees 中的員工 emp，都重複產生一列 <tr>。」 -->
				<tr>
					<td th:text="${emp.id}">1</td>
					<td th:text="${emp.username}">admin</td>
					<td th:text="${emp.realname} ?: '（未填）'">王小明</td>
					<!-- ?: 是 Thymeleaf 的「空值處理運算子」，意思是：如果 realname 是 null，就顯示「（未填）」 -->

					<!-- 根據角色名稱 emp.role，顯示不同顏色的 badge -->
					<td><span th:switch="${emp.role}"> <!-- th:switch 是 Thymeleaf 的「條件判斷」語法（類似 Java 的 switch） -->
							<span th:case="'ADMIN'" class="badge bg-danger">[[${emp.role}]]</span>
							<!-- th:case 是各種判斷值（字串需加引號 '...'） --> <span th:case="'SALES'"
							class="badge bg-warning text-dark">[[${emp.role}]]</span> <!-- [[${emp.role}]] 是 Thymeleaf 的 inline 語法，作用同 th:text，但可以在 span 中嵌套使用 -->
							<span th:case="'VIEWER'" class="badge bg-info text-dark">[[${emp.role}]]</span>
							<span th:case="*" class="badge bg-secondary">[[${emp.role}]]</span>
					</span></td>



					<!-- <td><span th:if="${emp.enabled}" class="text-success">啟用</span> -->
					<!-- th:if：只有在 emp.enabled 為 true 時才顯示這段 HTML -->
					<!-- <span th:unless="${emp.enabled}" class="text-muted">停用</span></td> -->
					<!-- th:unless：等同於 th:if="!..."，只有在條件為 false 時顯示 -->


					<td class="d-flex justify-content-center gap-2">
					
						<!--該員工角色權限切換  -->
						<button class="btn btn-sm btn-primary"
							data-bs-toggle="modal" data-bs-target="#roleModal"     
							th:attr="data-id=${emp.id}, data-role=${emp.role}">變更角色
							<!-- data-bs-toggle="modal"Bootstrap 內建功能：告訴瀏覽器「當這個按鈕被點擊時，要打開一個 Modal」
                                 data-bs-target="#roleModal"目標是 ID 為 roleModal 的 <div class="modal">...</div>
                                 Thymeleaf 動態加入兩個自訂的 data 屬性，在 JS用const id = button.dataset.id;把資料抓出來 → 丟到 Modal 的 <form> 裡面填入
							 -->
						</button> 
						
						<!--切換該帳號啟用or停用  -->
						<form th:action="@{/employee/toggle}" method="post"
							th:object="${emp}">
							<input type="hidden" name="id" th:value="${emp.id}" />
							<button type="submit"
								th:classappend="${emp.enabled} ? 'btn btn-sm btn-danger' : 'btn btn-sm btn-success'"
								th:text="${emp.enabled} ? '停用' : '啟用'"
								th:title="${emp.enabled} ? '切換成 停用' : '切換成 啟用'"
								data-bs-toggle="tooltip" data-bs-placement="right"></button>
						</form>
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- 變更角色 Modal -->
	<div class="modal fade" id="roleModal" tabindex="-1"
		aria-labelledby="roleModalLabel" aria-hidden="true"> <!-- id="roleModal" 會對應到按鈕的 data-bs-target="#roleModal" -->
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="roleForm" method="post" th:action="@{/employee/role}"> <!-- 對應post方法名稱 -->
					<div class="modal-header">
						<h5 class="modal-title" id="roleModalLabel">變更角色</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="關閉"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" name="id" id="empId"> <!-- 用來放員工的 ID（看不到，但會送給後端）之後用 JS 動態改變這個欄位的值 -->
						<div class="mb-3">
							<label for="newRole" class="form-label">選擇角色：</label> 
							<select class="form-select" id="newRole" name="role" required> <!-- 下拉選單新角色 -->
								<option value="ADMIN">ADMIN</option>
								<option value="SALES">SALES</option>
								<option value="VIEWER">VIEWER</option>
								<option value="ROOT">ROOT</option>
							</select>
						</div>
					</div>
					<div class="modal-footer">
						<button type="submit" class="btn btn-primary">儲存</button> <!-- type="submit"提交表單給遠端伺服器 -->
					</div>
				</form>
			</div>
		</div>
	</div>


	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
	/* 啟用停用切換小提示 */
		document.addEventListener('DOMContentLoaded', function() {
			const tooltipTriggerList = [].slice.call(document
					.querySelectorAll('[data-bs-toggle="tooltip"]'))
			tooltipTriggerList.forEach(function(tooltipTriggerEl) {
				new bootstrap.Tooltip(tooltipTriggerEl)
			})
		});
		
		
		/* 該員工角色權限切換 */
		const roleModal = document.getElementById('roleModal'); /* 取得Modal 元素，準備加監聽事 */
		  roleModal.addEventListener('show.bs.modal', function (event) { /* 監聽「Modal 開啟」的時機（不是點按鈕，而是準備打開 Modal 的瞬間） */
		    const button = event.relatedTarget; /* 觸發這個 Modal 的按鈕 */
		    const empId = button.getAttribute('data-id');
		    const empRole = button.getAttribute('data-role'); /* 按鈕身上的 data-* 屬性拿到該員工的 id 和角色 */

		    document.getElementById('empId').value = empId; /* 將拿到的 id 填入 <input type="hidden" ...>，之後表單送出會一起帶上 */
		    document.getElementById('newRole').value = empRole; /* 把目前角色選項帶進 <select> 裡，讓你看到該員工目前是什麼角色 */
		  });
	</script>
</body>

</html>
