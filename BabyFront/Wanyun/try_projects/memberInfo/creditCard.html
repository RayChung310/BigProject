<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>輸入卡號</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .credit-title {
      color: #65482c;
      font-weight: bold;
    }
      .credit-text {
      color: #504030;
      
    }
    .credit-modal-content {
      border-radius: 12px;
      padding: 2rem;
    }
    .credit-form-control::placeholder {
      color: #ccc;
    }
    .credit-btn-disabled {
      pointer-events: none;
      opacity: 0.5;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-5 text-center">
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cardModal">新增卡號</button>

  <div id="maskedCard" class="mt-4 text-muted"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content credit-modal-content">
      <h4 class="credit-title text-center">輸入卡號</h4>
      <form id="cardForm">
        <div class="mb-3">
          <label class="form-label credit-text">信用卡 / 簽帳金融卡卡號</label>
          <input type="text" id="cardNumber" class="form-control credit-form-control" placeholder="0000 0000 0000 0000" maxlength="19" required>
        </div>
        <div class="row mb-3">
          <div class="col">
            <label class="form-label credit-text">有效月年</label>
            <input type="text" id="expiry" class="form-control credit-form-control" placeholder="MM/YY" maxlength="5" required>
          </div>
          <div class="col">
            <label class="form-label credit-text">背面末三碼</label>
            <input type="text" id="cvv" class="form-control credit-form-control" placeholder="000" maxlength="3" required>
          </div>
        </div>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" id="nextBtn" class="btn btn-dark btn-disabled credit-btn-disabled">下一步</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const cardInput = document.getElementById('cardNumber');
  const expiryInput = document.getElementById('expiry');
  const cvvInput = document.getElementById('cvv');
  const nextBtn = document.getElementById('nextBtn');
  const maskedCardDiv = document.getElementById('maskedCard');

  function formatCardNumber(value) {
    return value.replace(/\D/g, '').replace(/(.{4})/g, '$1 ').trim();
  }

  function showMaskedCard() {
    const data = localStorage.getItem('creditCard');
    if (data) {
      const { cardNumber } = JSON.parse(data);
      const digits = cardNumber.replace(/\s/g, '');
      const masked = '**** **** **** ' + digits.slice(-4);
      maskedCardDiv.textContent = `已儲存卡號：${masked}`;
    }
  }

  cardInput.addEventListener('input', () => {
    cardInput.value = formatCardNumber(cardInput.value);
    validateForm();
  });

  expiryInput.addEventListener('input', validateForm);
  cvvInput.addEventListener('input', validateForm);

  function validateForm() {
    const card = cardInput.value.replace(/\s/g, '');
    const expiry = expiryInput.value;
    const cvv = cvvInput.value;

    const isCardValid = /^\d{16}$/.test(card);
    const isExpiryValid = /^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry);
    const isCVVValid = /^\d{3}$/.test(cvv);

    if (isCardValid && isExpiryValid && isCVVValid) {
      nextBtn.classList.remove('btn-disabled');
    } else {
      nextBtn.classList.add('btn-disabled');
    }
  }

  document.getElementById('cardForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const cardData = {
      cardNumber: cardInput.value,
      expiry: expiryInput.value,
      cvv: cvvInput.value
    };

    localStorage.setItem('creditCard', JSON.stringify(cardData));
    alert('卡號已儲存至 localStorage！');
    bootstrap.Modal.getInstance(document.getElementById('cardModal')).hide();
    this.reset();
    nextBtn.classList.add('btn-disabled');
    showMaskedCard();
  });

  // 初始化顯示儲存的卡號
  showMaskedCard();
</script>
</body>
</html>